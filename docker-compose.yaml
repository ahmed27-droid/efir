services:
  postgres:
    image: postgres:16
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: arhimed2734
      # default database is 'postgres'; additional DBs created via init script below
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./infra/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro

  kafka:
    image: apache/kafka:3.7.0
    ports:
      - "9092:9092"
      - "29092:29092"
    volumes:
      - kafka_data:/var/lib/kafka/data
      - ./infra/kafka/server.properties:/opt/kafka/config/kraft/server.properties
      - ./infra/kafka/topics.sh:/opt/kafka/topics.sh
    command:
      - bash
      - -c
      - |
          set -e
          if [ ! -f /var/lib/kafka/data/meta.properties ]; then
            echo "Formatting KRaft storage"
            /opt/kafka/bin/kafka-storage.sh format \
              --cluster-id kraft-cluster-1 \
              --config /opt/kafka/config/kraft/server.properties
          fi

          exec /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/kraft/server.properties

  kafka-ui:
    image: kafbat/kafka-ui:main
    ports:
      - "8090:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    depends_on:
      - kafka

  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    ports:
      - "8088:8088"
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASS: arhimed2734
      DB_NAME: user_service
      JWT_SECRET: your-secret-key-here
    depends_on:
      - postgres
      - kafka
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8088/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  broadcast-service:
    build:
      context: ./broadcast-service
      dockerfile: Dockerfile
    ports:
      - "8082:8082"
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASS: arhimed2734
      DB_NAME: broadcast_service
      KAFKA_BROKERS: kafka:9092
      SERVICE_PORT: 8082
    depends_on:
      - postgres
      - kafka
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8082/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  comment-service:
    build:
      context: ./comment-service
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASS: arhimed2734
      DB_NAME: comment_service
      REDIS_ADDR: redis:6379
      KAFKA_BROKERS: kafka:9092
      BROADCAST_SERVICE_URL: http://broadcast-service:8082
    depends_on:
      - postgres
      - kafka
      - redis
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  notification-service:
    build:
      context: ./notification-service
      dockerfile: Dockerfile
    ports:
      - "8083:8083"
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASS: arhimed2734
      DB_NAME: notification_service
      KAFKA_BROKERS: kafka:9092
      SERVICE_PORT: 8083
    depends_on:
      - postgres
      - kafka
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8083/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    ports:
      - "8092:8092"
    environment:
      JWT_SECRET: your-secret-key-here
      USER_SERVICE_URL: http://user-service:8088
      BROADCAST_SERVICE_URL: http://broadcast-service:8082
      COMMENT_SERVICE_URL: http://comment-service:8080
      NOTIFICATION_SERVICE_URL: http://notification-service:8083
    depends_on:
      - user-service
      - broadcast-service
      - comment-service
      - notification-service
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8092/health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  pg_data:
  kafka_data:
  redis_data:
